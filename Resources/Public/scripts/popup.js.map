{"version":3,"sources":["../../Private/Scripts/popup.js"],"names":["initializePopup","popup","document","querySelector","popupsArray","getCookie","JSON","parse","length","popupUri","dataset","popupDelay","popupDelayType","popupDelaytype","registerPopup","renderPopupContainer","listenForCloseHandlers","renderPopup","setTimeout","showPopup","filter","object","delayType","shown","clickPopups","forEach","clickPopup","clicks","delay","url","popModalHTML","createElement","innerHTML","className","insertAdjacentElement","find","undefined","push","parseInt","setCookie","stringify","console","info","registerClickIncrementForPopups","popups","updatedPopups","map","popupHasShown","result","Array","isArray","markPopupAsShown","fetch","then","res","text","parser","DOMParser","html","parseFromString","container","popupOuterContainer","classList","add","closePopup","currentPopup","remove","popupUrl","addEventListener","e","isOutside","target","closest","window","key","anchors","querySelectorAll","anchor","cname","cvalue","exdays","d","Date","setTime","getTime","expires","toUTCString","cookie","name","ca","split","i","c","charAt","substring","indexOf"],"mappings":"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","sourcesContent":["function initializePopup() {\n  // Setup\n  const popup = document.querySelector('[data-popup]');\n  let popupsArray = getCookie('u_popups') ? JSON.parse(getCookie('u_popups')) : [];\n\n  // If no popup is stored or loaded...\n  if (!popup && popupsArray.length === 0) return;\n\n  // Popups loaded in the page (used to register and to show popups with the delaytype `seconds`)\n  if (popup) {\n    const popupUri = popup.dataset.popup;\n    const popupDelay = popup.dataset.popupDelay;\n    const popupDelayType = popup.dataset.popupDelaytype;\n\n    registerPopup(popupUri, popupDelay, popupDelayType);\n\n    switch (popupDelayType) {\n      case 'clicks': // Skip rendering until clicks have resolved\n        break;\n      case 'seconds':\n      default:\n        renderPopupContainer();\n        listenForCloseHandlers();\n        renderPopup(popupUri);\n        setTimeout(() => showPopup(popupUri), popupDelay * 1000);\n        break;\n    }\n  }\n\n  // Popups loaded from cookies\n  if (popupsArray.filter(object => object.delayType === 'clicks' && object.shown === false).length > 0) {\n    const clickPopups = popupsArray.filter(object => object.delayType === 'clicks');\n    if (clickPopups.length > 0) {\n      renderPopupContainer();\n      listenForCloseHandlers();\n      clickPopups.forEach(clickPopup => {\n        if (clickPopup.clicks > clickPopup.delay) {\n          renderPopup(clickPopup.url);\n          setTimeout(() => showPopup(clickPopup.url), 1000);\n        }\n      })\n    }\n  }\n\n  function renderPopupContainer() {\n    const popModalHTML = document.querySelector('.popup-modal__outer') ? document.querySelector('.popup-modal__outer') : document.createElement('div');\n    popModalHTML.innerHTML = '<button class=\"popup-modal__close-button\">&times;</button><div class=\"popup-modal__inner\"></div>';\n    popModalHTML.className = 'popup-modal__outer';\n    document.querySelector('body').insertAdjacentElement('beforeend', popModalHTML);\n  }\n\n  function registerPopup(popupUri, popupDelay, popupDelayType) {\n    if (popupsArray.find(object => object.url === popupUri) === undefined) {\n      popupsArray.push({\n        url: popupUri,\n        delay: parseInt(popupDelay),\n        delayType: popupDelayType,\n        clicks: popupDelayType === 'clicks' ? 1 : null,\n        shown: false\n      });\n      setCookie('u_popups', JSON.stringify(popupsArray));\n      console.info(`Popup ${popupUri} registered`);\n    }\n  }\n\n  function registerClickIncrementForPopups() {\n    const popups = JSON.parse(getCookie('u_popups'));\n    const clickPopups = popups.filter(object => object.delayType === 'clicks');\n    let updatedPopups = popups.map(object => {\n      if (clickPopups.find(clickPopup => clickPopup.url === object.url)) {\n        object.clicks++;\n      }\n      return object;\n    });\n    setCookie('u_popups', JSON.stringify(updatedPopups));\n  }\n\n  function popupHasShown(popupUri) {\n    const popups = JSON.parse(getCookie('u_popups'));\n    const result = popups.map(object => (object.url === popupUri && object.shown === true));\n    return Array.isArray(result) && result[0] === true;\n  }\n\n  function markPopupAsShown(popupUri) {\n    const popups = JSON.parse(getCookie('u_popups'));\n    const updatedPopups = popups.map(object => object.url === popupUri ? {...object, shown: true} : object);\n    setCookie('u_popups', JSON.stringify(updatedPopups));\n  }\n\n  function renderPopup(popupUri) {\n    fetch(popupUri)\n      .then(function (res) {\n        return res.text()\n      })\n      .then(function (result) {\n        const parser = new DOMParser();\n        const html = parser.parseFromString(result, \"text/html\");\n        const container = document.querySelector('.popup-modal__inner');\n\n        container.insertAdjacentElement('beforeend', html.querySelector('body > div'));\n      });\n  }\n\n  function showPopup(popupUri) {\n    const popupOuterContainer = document.querySelector('.popup-modal__outer');\n    if (popupHasShown(popupUri) === false) {\n      popupOuterContainer.classList.add('is-active');\n    }\n  }\n\n  function closePopup() {\n    const popupOuterContainer = document.querySelector('.popup-modal__outer');\n    const currentPopup = popupOuterContainer.querySelector('[data-popup]');\n    popupOuterContainer.classList.remove('is-active');\n    markPopupAsShown(currentPopup.dataset.popupUrl);\n  }\n\n  function listenForCloseHandlers() {\n    const popupOuterContainer = document.querySelector('.popup-modal__outer');\n    popupOuterContainer.addEventListener('click', function (e) {\n      const isOutside = !e.target.closest('.popup-modal__inner');\n      if (isOutside) {\n        closePopup()\n      }\n    });\n\n    window.addEventListener('keydown', function (e) {\n      if (e.key === 'Escape') {\n        closePopup();\n      }\n    });\n  }\n\n  // Setup listening for clicks so we can track them for clickPopups\n  // We pass in the cookie values directly to get live updated values i.o. previous\n  // stored array.\n  const anchors = document.querySelectorAll('a');\n  anchors.forEach(anchor => anchor.addEventListener('click', e => {\n    registerClickIncrementForPopups();\n  }));\n  window.addEventListener('beforeunload', () => {\n    registerClickIncrementForPopups();\n  });\n\n  function setCookie(cname, cvalue, exdays) {\n    var d = new Date();\n    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));\n    var expires = \"expires=\" + d.toUTCString();\n    document.cookie = cname + \"=\" + cvalue + \";\" + expires + \";path=/\";\n  }\n\n  function getCookie(cname) {\n    var name = cname + \"=\";\n    var ca = document.cookie.split(';');\n    for (var i = 0; i < ca.length; i++) {\n      var c = ca[i];\n      while (c.charAt(0) === ' ') {\n        c = c.substring(1);\n      }\n      if (c.indexOf(name) === 0) {\n        return c.substring(name.length, c.length);\n      }\n    }\n\n    return '';\n  }\n\n}\n\ninitializePopup();\n"],"file":"popup.js"}